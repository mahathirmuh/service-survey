<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase SQL Executor</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.34.3/dist/umd/supabase.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1, h2 {
            color: #3ECF8E;
        }
        .container {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
        }
        textarea {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
            margin-bottom: 10px;
        }
        button {
            background-color: #3ECF8E;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #2EAF7E;
        }
        .result {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .error {
            color: red;
        }
        .success {
            color: green;
        }
        .hidden {
            display: none;
        }
        .credentials {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .step {
            margin-bottom: 30px;
        }
        .step-number {
            display: inline-block;
            background-color: #3ECF8E;
            color: white;
            width: 30px;
            height: 30px;
            text-align: center;
            line-height: 30px;
            border-radius: 50%;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <h1>Supabase SQL Executor</h1>
    <p>This tool helps you execute SQL commands on your Supabase database to add missing columns.</p>

    <div class="step">
        <h2><span class="step-number">1</span>Enter Supabase Credentials</h2>
        <div class="credentials">
            <input type="text" id="supabaseUrl" placeholder="Supabase URL (e.g., https://uwbqdiwuczhorzdzdlqp.supabase.co)" value="https://uwbqdiwuczhorzdzdlqp.supabase.co">
            <input type="password" id="supabaseKey" placeholder="Supabase Service Role Key">
        </div>
    </div>

    <div class="step">
        <h2><span class="step-number">2</span>SQL Commands</h2>
        <div class="container">
            <textarea id="sqlCommands">-- Add all environmental, external, HR, and SCM columns
ALTER TABLE public.survey_responses 
ADD COLUMN IF NOT EXISTS environmental_audit_question1 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS environmental_audit_question2 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS environmental_audit_feedback TEXT,
ADD COLUMN IF NOT EXISTS environmental_management_question1 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS environmental_management_question2 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS environmental_management_feedback TEXT,
ADD COLUMN IF NOT EXISTS environmental_monitoring_question1 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS environmental_monitoring_question2 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS environmental_monitoring_feedback TEXT,
ADD COLUMN IF NOT EXISTS environmental_study_question1 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS environmental_study_question2 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS environmental_study_feedback TEXT,
ADD COLUMN IF NOT EXISTS external_assetprotection_question1 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS external_assetprotection_question2 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS external_assetprotection_feedback TEXT,
ADD COLUMN IF NOT EXISTS external_govrel_question1 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS external_govrel_question2 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS external_govrel_feedback TEXT,
ADD COLUMN IF NOT EXISTS external_communityrelations_question1 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS external_communityrelations_question2 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS external_communityrelations_feedback TEXT,
ADD COLUMN IF NOT EXISTS external_legal_question1 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS external_legal_question2 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS external_legal_feedback TEXT,
ADD COLUMN IF NOT EXISTS external_communications_question1 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS external_communications_question2 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS external_communications_feedback TEXT,
ADD COLUMN IF NOT EXISTS hr_comben_question1 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS hr_comben_question2 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS hr_comben_feedback TEXT,
ADD COLUMN IF NOT EXISTS hr_recruitment_question1 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS hr_recruitment_question2 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS hr_recruitment_feedback TEXT,
ADD COLUMN IF NOT EXISTS hr_training_question1 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS hr_training_question2 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS hr_training_feedback TEXT,
ADD COLUMN IF NOT EXISTS hr_performance_question1 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS hr_performance_question2 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS hr_performance_feedback TEXT,
ADD COLUMN IF NOT EXISTS hr_ir_question1 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS hr_ir_question2 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS hr_ir_feedback TEXT,
ADD COLUMN IF NOT EXISTS hr_documentcontrol_question1 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS hr_documentcontrol_question2 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS hr_documentcontrol_feedback TEXT,
ADD COLUMN IF NOT EXISTS hr_itsupport_question1 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS hr_itsupport_question2 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS hr_itsupport_feedback TEXT,
ADD COLUMN IF NOT EXISTS hr_itfield_question1 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS hr_itfield_question2 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS hr_itfield_feedback TEXT,
ADD COLUMN IF NOT EXISTS hr_siteservice_question1 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS hr_siteservice_question2 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS hr_siteservice_feedback TEXT,
ADD COLUMN IF NOT EXISTS hr_peopledev_question1 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS hr_peopledev_question2 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS hr_peopledev_feedback TEXT,
ADD COLUMN IF NOT EXISTS hr_translator_question1 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS hr_translator_question2 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS hr_translator_feedback TEXT,
ADD COLUMN IF NOT EXISTS hr_talentacquisition_question1 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS hr_talentacquisition_question2 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS hr_talentacquisition_feedback TEXT,
ADD COLUMN IF NOT EXISTS scm_inventory_question1 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS scm_inventory_question2 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS scm_inventory_feedback TEXT,
ADD COLUMN IF NOT EXISTS scm_procurement_question1 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS scm_procurement_question2 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS scm_procurement_feedback TEXT,
ADD COLUMN IF NOT EXISTS scm_logistic_question1 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS scm_logistic_question2 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS scm_logistic_feedback TEXT,
ADD COLUMN IF NOT EXISTS scm_warehouse_question1 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS scm_warehouse_question2 INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS scm_warehouse_feedback TEXT;

-- Verify columns were added
SELECT 
  column_name, 
  data_type 
FROM 
  information_schema.columns 
WHERE 
  table_schema = 'public' AND 
  table_name = 'survey_responses' AND
  (column_name LIKE 'environmental_%' OR column_name LIKE 'external_%' OR column_name LIKE 'hr_%');</textarea>
            <button id="executeBtn">Execute SQL</button>
        </div>
    </div>

    <div class="step">
        <h2><span class="step-number">3</span>Results</h2>
        <div class="container">
            <div id="resultContainer" class="result hidden"></div>
        </div>
    </div>

    <div class="step">
        <h2><span class="step-number">4</span>Next Steps</h2>
        <div class="container">
            <p>After successfully adding the columns, run the import script to import the data:</p>
            <pre>node import-to-new-project.js</pre>
            <p>Then verify the data in the Supabase Dashboard and test the application.</p>
        </div>
    </div>

    <script>
        document.getElementById('executeBtn').addEventListener('click', async function() {
            const supabaseUrl = document.getElementById('supabaseUrl').value.trim();
            const supabaseKey = document.getElementById('supabaseKey').value.trim();
            const sqlCommands = document.getElementById('sqlCommands').value.trim();
            const resultContainer = document.getElementById('resultContainer');
            
            resultContainer.classList.remove('hidden');
            resultContainer.innerHTML = 'Executing SQL commands...';
            
            if (!supabaseUrl || !supabaseKey) {
                resultContainer.innerHTML = '<span class="error">Please enter Supabase URL and Service Role Key.</span>';
                return;
            }
            
            try {
                // Create Supabase client
                const supabase = supabase.createClient(supabaseUrl, supabaseKey);
                
                // Split SQL commands by semicolon
                const commands = sqlCommands.split(';').filter(cmd => cmd.trim());
                
                let results = [];
                
                for (const command of commands) {
                    try {
                        // Execute SQL command using RPC
                        const { data, error } = await supabase.rpc('exec_sql', {
                            sql_string: command.trim()
                        });
                        
                        if (error) throw error;
                        
                        results.push({
                            command: command.trim(),
                            result: data,
                            success: true
                        });
                    } catch (error) {
                        // Try direct query as fallback
                        try {
                            const { data, error: queryError } = await supabase.from('rpc').select('*').rpc('exec_sql', {
                                sql_string: command.trim()
                            });
                            
                            if (queryError) throw queryError;
                            
                            results.push({
                                command: command.trim(),
                                result: data,
                                success: true
                            });
                        } catch (fallbackError) {
                            results.push({
                                command: command.trim(),
                                error: fallbackError.message || 'Unknown error',
                                success: false
                            });
                        }
                    }
                }
                
                // Display results
                let resultHtml = '';
                
                for (const result of results) {
                    resultHtml += `<h3>Command:</h3><pre>${result.command}</pre>`;
                    
                    if (result.success) {
                        resultHtml += `<h3 class="success">Success!</h3>`;
                        
                        if (result.result && typeof result.result === 'object') {
                            resultHtml += `<pre>${JSON.stringify(result.result, null, 2)}</pre>`;
                        }
                    } else {
                        resultHtml += `<h3 class="error">Error:</h3><pre class="error">${result.error}</pre>`;
                        resultHtml += `<p>Please try executing this SQL command manually in the Supabase SQL Editor.</p>`;
                    }
                    
                    resultHtml += '<hr>';
                }
                
                resultContainer.innerHTML = resultHtml;
                
                // Check if all commands were successful
                const allSuccessful = results.every(r => r.success);
                
                if (allSuccessful) {
                    resultContainer.innerHTML += `
                        <h3 class="success">All SQL commands executed successfully!</h3>
                        <p>You can now run the import script:</p>
                        <pre>node import-to-new-project.js</pre>
                    `;
                } else {
                    resultContainer.innerHTML += `
                        <h3 class="error">Some SQL commands failed.</h3>
                        <p>Please execute the failed commands manually in the Supabase SQL Editor.</p>
                    `;
                }
                
            } catch (error) {
                resultContainer.innerHTML = `<span class="error">Error: ${error.message || 'Unknown error'}</span>`;
                resultContainer.innerHTML += `<p>Please execute the SQL commands manually in the Supabase SQL Editor.</p>`;
            }
        });
    </script>
</body>
</html>